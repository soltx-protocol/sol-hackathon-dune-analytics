-- https://dune.com/queries/632683

with data as (
select
  block_time,
  tx_index,
  address,
  token_mint_address,
  post_token_balance,
  row_number() over (partition by token_mint_address, address order by block_time desc, tx_index desc) as row_num
from
  solana.account_activity
where
  -- poolTokenMint
  token_mint_address in ('9rguDaKqTrVjaDXafq6E7rKGn7NPHomkdb8RKpjKCDm2', 'ECFcUGwHHMaZynAQpqRHkYeTBnS5GnPWZywM8aggcs3A', '3H5XKkE9uVvxsdrFeN4BLLGCmohiQN6aZJVVcJiXQ4WC', '7TYb32qkwYosUQfUspU45cou7Bb3nefJocVMFX2mEGTT', '8pFwdcuXM7pvHdEGHLZbUR8nNsjj133iUXWG6CgdRHk2', '7bb88DAnQY7LSoWEuqezCcbk4vutQbuRqgJMqpX8h6dL', 'GWEmABT4rD3sGhyghv9rKbfdiaFe5uMHeJqr6hhu3XvA', 'BmZNYGt7aApGTUUxAQUYsW64cMbb6P7uniokCWaptj4D', '6ojPekCSQimAjDjaMApLvh3jF6wnZeNEVRVVoGNzEXvV', 'YJRknE9oPhUMtq1VvhjVzG5WnRsjQtLsWg3nbaAwCQ5', 'C9PKvetJPrrPD53PR2aR8NYtVZzucCRkHYzcFXbZXEqu', '6SfhBAmuaGf9p3WAxeHJYCWMABnYUMrdzNdK5Stvvj4k', '9r1n79TmerAgQJboUT8QvrChX3buZBfuSrBTtYM1cW4h', 'ELLELFtgvWBgLkdY9EFx4Vb3SLNj4DJEhzZLWy1wCh4Y', 'BXM9ph4AuhCUzf94HQu5FnfeVThKj5oyrnb1krY1zax5', 'FJ9Q9ojA7vdf5rFbcTc6dd7D3nLpwSxdtFSE8cwfuvqt', 'EHkfnhKLLTUqo1xMZLxhM9EusEgpN6RXPpZsGpUsewaa', '2697FyJ4vD9zwAVPr33fdVPDv54pyZZiBv9S2AoKMyQf', '33k9G5HeH5JFukXTVxx3EmZrqjhb19Ej2GC2kqVPCKnM', 'APDFRM3HMr8CAGXwKHiu2f5ePSpaiEJhaURwhsRrUUt9', 'FZthQCuYHhcfiDma7QrX7buDHwrZEd7vL8SjS6LQa3Tx', '71FymgN2ZUf7VvVTLE8jYEnjP3jSK1Frp2XT1nHs8Hob', '3e1W6Aqcbuk2DfHUwRiRcyzpyYRRjg6yhZZcyEARydUX', '5kimD5W6yJpHRHCyPtnEyDsQRdiiJKivu5AqN3si82Jc', 'ADrvfPBsRcJfGsN6Bs385zYddH52nuM5FA8UaAkX9o2V', '8nTzqDXHriG2CXKbybeuEh1EqDQMtrbYMFWcP7AkiDaP', '9tf8rBSEQYG7AqL896fN2nZi1iYPqpWaLEdpbeQaC1Vy', 'EsYaDKJCmcJtJHFuJYwQZwqohvVMCrFzcg8yo3i328No', 'CzieDbGRdN1QGaGDNpSqzEA18bi881ccvkkGZi51pe1k', '7tYCdLN84EnTMkxM7HNamWJx7F4xgKe9KiiWvLyWjbgT', 'Acxs19v6eUMTEfdvkvWkRB4bwFCHm3XV9jABCy7c1mXe', 'HiwRobjfHZ4zsPtqCC4oBS24pSmy4t8GGkXRbQj4yU6L', 'EYsNdtyu4gGTaGz8N5m5iQ3G1N6rDyMbR72B3CqbWW4W', '99pfC8fWymXgbq3CvrExhx3UxQDC1fMWEWLbNT83F45e', 'H2uzgruPvonVpCRhwwdukcpXK8TG17swFNzYFr2rtPxy', '2uVjAuRXavpM6h1scGQaxqb6HVaNRn6T2X7HHXTabz25', 'n8Mpu28RjeYD7oUX3LG1tPxzhRZh3YYLRSHcHRdS3Zx', 'HEvnD66WcBfTajS9adUYnGRBMDehFtLySiFHSD6kEBWs', 'D6N9j8F2DhtzDtrdpT74y3u2YmYAzcggiLc3nTjqux9M', '3PD9SZFwXKkXr4akLf4ofo37ZUMycwML89R2P3qxcbZG', 'AZpo4BJHHRetF96v6SGinFZBMXM4yWMo4RA8C4PriDLk', '8PSfyiTVwPb6Rr2iZ8F3kNpbg65BCfJM9v8LfB916r44', 'AtB4nUmdyQfuWWJ9xAHw9xyVnJFfSjSuVWkiYan8y86w', 'F8gPSpwVHj8FdAJAYULDuZBxFEJut87hUbARYYx3471w', 'CS7fA5n4c2D82dUoHrYzS3gAqgqaoVSfgsr18kitp2xo', 'Dkr8B675PGnNwEr9vTKXznjjHke5454EQdz3iaSbparB', 'C2YzN6MymD5HM2kPaH7bzcbqciyjfmpqyVaR3KA5V6z1', '29cdoMgu6MS2VXpcMo1sqRdWEzdUR9tjvoh8fcK8Z87R', 'C7TH2jEJJaxVwwuvkbcDGfHUiZvEkkeYjyAcdTMi5ujb', 'CVapmQn7HaU1yMDW3q6oUV4hx6XoYv54T4zfGXkuJqkA', 'APNpzQvR91v1THbsAyG3HHrUEwvexWYeNCFLQuVnxgMc', 'FZ8x1LCRSPDeHBDoAc3Gc6Y7ETCynuHEr5q5YWV7uRCJ', 'GteBdo9sqE7T41G8AJsaG9WHW48uXBwsLLznmu2TBdgy', '2gXDJZ7XAtQEtf4PRSQZKoq1WMuu1H44tQanbMA3YVpu', '6VK1ksrmYGMBWUUZfygGF8tHRGpNxQEWv8pfvzQHdyyc', '4X1oYoFWYtLebk51zuh889r1WFLe8Z9qWApj87hQMfML', 'BVWwyiHVHZQMPHsiW7dZH7bnBVKmbxdeEjWqVRciHCyo', 'ELfBngAgvLEHVBuJQhhE7AW6eqLX7id2sfrBngVNVAUW', 'HsauTv9s52Zv12eaDuSp6y7BEm4e4BHEyAsbdjyyWzPK', 'GHuoeq9UnFBsBhMwH43eL3RWX5XVXbSRYJymmyMYpT7n', 'EorFh8siFyLF1QTZ7cCXQaPGqyo7eb4SAgKtRH8Jcxjd', 'GMzPbaCuQmeMUm1opH3oSCgKUjVgJUW14myq99RVPGX5', 'DRknxb4ZFxXUTG6UJ5HupNHG1SmvBSCPzsZ1o9gAhyBi', '2toFgkQDoPrTJYGDEVoCasPXuL9uQnjvXJaDwa9LHyTx', '4SBx8GXu8HhcVHWydQv1vsDdZs3G93XSL9CtMBny6hS5', 'H9yC7jDng974WwcU4kTGs7BKf7nBNswpdsP5bzbdXjib', 'Eswigpwm3xsipkTqahGi2PEJsJcULQBwZgxhQpr6yBEa', 'qJxKN9BhxbYvRNbjfK2uAVWboto6sonj8XC1ZEW5XTB', '74B9aMS7SA832xKngt5VLKmWAP3pa3qkUzWncTmQSsGF', '7aYnrdmdCRodDy2Czn6keUquUhjF1jPEmfwZPh488z8U', '7NPtjjAP7vhp4t5NCLyY4DY5rurvyc8cgZ2a2rYabRia', '5PHS5w6hQwFNnLz1jJFe7TVTxSQ98cDYC3akmiAoFMXs', 'Df6XNHMF3uRVZnz7LCEGiZVax6rXgz76owtVkBHEjSb6', '9cMWe4UYRPGAUUsTkjShJWVM7bk8DUBgxtwwH8asFJoV', '5qoTq3qC4U7vFxo3iCzbXcaD1UEmDeCD63Dsuoct71oV', '8nKJ4z9FSw6wrVZKASqBiS9DS1CiNsRnqwCCKVQjqdkB', 'DfgCnzaiTXfPkAH1C1Z441b5MzjjTCEh134ioxqRZxYf', '8sfThep3io4gvcGeuoAg1Rs8GDwKJjtcdAFHqQSSNAVE', '6jCERp5hKj37PCXP3VTjCDJeoPuSpnMDMz5A6jWQv3yS', 'GBijunwxa4Ni3JmYC6q6zgaVhSUJU6hVX5qTyJDRpNTc', 'GtQ1NT7R5aaTiST7K6ZWdMhwDdFxsSFvVFhBo8vyHGAq', '5a6Y1ephcbKSoyLMQyD1JWbtqawCy8p2FtRL9v3zhaG5', '6mJqqT5TMgveDvxzBt3hrjGkPV5VAj7tacxFCT3GebXh', 'Hmfrtmo93DpSDmVNLQKcBS5D1ia5JatiRSok9ososubz', 'FwCombynV2fTVizxPCNA2oZKoWXLZgdJThjE4Xv9sjxc', '4cXw2MYj94TFBXLL73fEpMCr8DPrW68JvrV8mzWgktbD', 'F59gkD7NnsdJbFKrRZsiBC8PAooN4c56T8QmahfW1iXN', '7vnps4VE5RTGAr5fmPZu7fSrk2VnM4Up838grZfqmxqE', '9EjcYfHcG8f1mccpHyaAwpoxaUPiheC6KgLQjyD9aTb6', 'CHTKUJGYRtBDqnxCFjxe5KEkZgxV98udbhuYYyzGxup5', '55r9txzQtmjTykmTXmBYZCVMg5z9squB8b5cSw2AhxA4', 'DSiHyHDn96bUQSZtizyCRLcQzrwohZeMpVu8rYJN1HzG', '5MvQHx8eftU39JTucFsT315JFnQASuDQg3FqxTw7xcvN', 'HNrYngS1eoqkjWro9D3Y5Z9sWBDzPNK2tX4rfV2Up177', 'AWrtTWG4Zgxw8D92bb3L3sQtGLD3zDztMPWsXSph8iBP', '9Y1vPaAsMz8X65DebMMnmBjbMo8i4jh4mcgiggZUUS3M', 'FnDxJPNk7pPmGHUbR4XUHmHevrkXHdna5D3sQKcAtjBL', 'FGgP1npQTsC5Q4xBmQtNYSh51NKqNwdxBZy8JCo3igcu', 'E1U63VXhNiWoUkVvjrfLDdV1oJrwE6zLde3bohr6jCqz', 'GjG7JjTQfQpDxw4hWx4etP9oTaYCuCbPjsU8WaUT3xHB', 'D8WjqtwC9CzBrQKfSf2ccCHFQuPYwyLv5KAy8WjT5vnf', '34Ppq6R8NfYBwWwPY4cBK4Afyb8hHaASQFukCzH6cV4n', 'HjR8JgqNKQVMvdryqJw5RJ4PCE9WGk8sgbEF7S9S3obv', 'J3kvcay3N16FBdawgnqoJ9v9p6XCvyCLE2Z9F5RLvGkj', '12Uj74zgUUoBe4yeackwQ4qYtFMr9fk1xL6q5Nha6t2N', '71CBZeJ4tw38L9pSPoCz4fRsuWE64Fipyzotte7haoCS', '6MF5CHWAj5mS7FhpxiKz37CzR2eYTu236XpBKKMXCrGg', 'HDgxKmiA8Pv82fNguhVeMkZqQkos2YksFPoP1KttWxX8', '2VuGzaMrDnDyZfYvDwSXk38s7M2wpud7LDY3dGA1J9sy', 'GoaAiajubRgeCFEz9L6mLnSmT2QFegoJDH5tpLfivpj', 'E6FUnQHGHJVJg7oExVr5Moeaj1QpdpZQF5odYjHXWPZb', 'F5BTnwuMA6rxftTdbZ33VWKr2wrr6DuQHnd4guKmPSYQ', 'HCtyJzFUtYecXrA52s4Y9atq4J1fhT3cYsTX17XVSFag', 'DJqqvzSuPaWThfzwMjXx7H2ZmHDdwxza6NtFudtuXcpc', '2ws7g3LBPdctfKn42Di9qxzQtUJ8ZL1aEAX2rGEQMNqh', '99ZHUQsgxL7K6PHrGNi1gSwawwPr7UA5fbWrYoHQ6qhX', 'E5kSBqTDxFLbLNQaVVtPtnhEYVLMCK2fVSEKoMKL98qR', '6c13xsmyk7UaHUWZ2rm1MM3ZdrQRSBkQ9waaG25ridVs', 'J1KfRtP5y2warpD7LdJhfBLPKoWwSqYuovdArSv1mpQ7', '68YVjgPnTUPcBqZyghqvD2WPNsrLKsjYTmBKJzHRr4qd', '8Mh7drLbt3jFJYwp948XyvQscGLaLkChNcaH5wwaAoWA', 'HTZd53fYwYQRyAjiaPsZy9Gf41gobFdqkF4oKe3XLi95', 'AzEoVuNJyo9ByoLRZ5t6vav2Zg24vULNVJM41PgCKUqR', 'CCyDxjdW3G7hPTthTMPTZ4bnhFF19XG6rx2fNiKeRQww', 'Gx4PoxenyQwhGGnKagAT35iVg4im1iKhJxDWqVhgu6tk', 'GsfyYHkSgC3Ta6aWR9MjB2sxoBrkGGeR2tAwXbpphf3', '7cuu94swKL5PtFQohKMAzyd1mjj65rgMW3GzLY31HCnK', '85krvT9DxdYgoFLQDHTAGdvtNuLdAsc4xE5FkVLpN2aR', 'HVLyX8mD8YvKgZJ4oB6rXJiCYMLpHKwB6iCiCjE1XwdT', 'Gpzd833qSmv3kXpQmxEaqkrZTXZaRjhNAoqhf61qAhTG', 'DFpLFcQZqDKykyDePgip4r6MExVmBKWqTa12ezq6qxUY', 'cL5WhffCYFRLM4We8VS2W684kM4pHyuvEDwp8Ddw48k', 'FkKzu2HeMJZf4oHwoYPxLGVy3net5Jq8HAfnA5VqETgk', '2Reqt4Sw9xNY8BoJ3EZLpFu5yVgNxFrbw8M3KiJpPn6o', '4ni1nho89cDKAQ9ddbNQA9ieLYpzvJVmJpuogu5Ct5ur', 'H7gyTmNCDXkD8MGMqnxqoD8ANszjcju4tjT6ERZ5dakf', '3hksYA17VxgiKSeihjnZkBbjc2CTbEBfvDCYgQhojTo5', 'AaZRnJAnDyJyPD9uPJpJ8bzBGDCEi6jtBpUf92xErWPp', '9wPhuYapychVDSxmXqCZxy2Ka8Lmav4SHM72si8bfraV', 'Eho8h1BcoG5QWU7X9FzJafw5ErKUXtR2LobAJJZfWff4', '4iyU77yZbg8iD344vbwruAuDAf9i1EVV3FhZJDnWStBE', '3dXdXg5HPyZ73GFC9LkSn3thdJUGeXWB8iSTHs5UcqiH', '2LYgm6nGXmSSjfoEriPuYeGoNiWNxUs7n3rnTbDWN5c7', 'CFxQF5kNAtbbDj298Xr47Sf4mkSyuzWpRH97hrdQ6kxi', 'DdAFNvDxtEHCgKj3JAM64zCKfMWhs4J9wEmRrjUAFiME', '7n2YW9qLkhGFArdZPLoF4hYPE2zw7xCACkVPXrUWnLuo')
and
  block_date between (current_date - interval {{dateRange}} day) and (current_date - interval 1 day)
and
  post_token_balance is not null
and
  post_token_balance > 0
)
select
  *,
  if(row_number() over (order by total_amount desc) <= 5, token_mint_address, 'Others') as address_with_category
from
(select
  token_mint_address,
  round(sum(post_token_balance), 2) as total_amount
from
  data
where
  row_num = 1
and
  if('{{baseTokenMint}}' = 'default', true, '{{baseTokenMint}}' = token_mint_address)
group by
  token_mint_address)
